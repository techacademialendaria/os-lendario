/**
 * Apply RLS policy for public read of mind_profiles
 *
 * This script creates the necessary RLS policy to allow
 * public read access to profiles of public minds.
 *
 * Run: node --env-file=.env app/scripts/apply-profiles-rls.mjs
 */

import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.VITE_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

const SQL = `
-- 1. Add is_ai_generated column
ALTER TABLE mind_profiles
ADD COLUMN IF NOT EXISTS is_ai_generated BOOLEAN DEFAULT true;

COMMENT ON COLUMN mind_profiles.is_ai_generated IS 'True if generated by AI, false if human-authored';

-- 2. Update existing profiles to mark as AI generated
UPDATE mind_profiles
SET is_ai_generated = true
WHERE is_ai_generated IS NULL;

-- 3. Drop existing policy if exists
DROP POLICY IF EXISTS "Allow public read mind_profiles" ON mind_profiles;

-- 4. Create public read policy for mind_profiles
CREATE POLICY "Allow public read mind_profiles"
ON mind_profiles FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM minds
    WHERE minds.id = mind_profiles.mind_id
    AND minds.privacy_level = 'public'
  )
);
`;

console.log('='.repeat(60));
console.log('RLS Policy for mind_profiles');
console.log('='.repeat(60));
console.log();
console.log('To enable public read of mind_profiles, run this SQL');
console.log('in the Supabase Dashboard SQL Editor:');
console.log();
console.log('-'.repeat(60));
console.log(SQL);
console.log('-'.repeat(60));
console.log();
console.log('After applying, test with:');
console.log('  node --env-file=.env app/scripts/check-rls.mjs');
